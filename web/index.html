<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recipe Recommender - Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg:#ffffff;          /* page background */
      --panel:#fff7ed;       /* soft orange panel (orange-50) */
      --panel-border:#fed7aa;/* orange-200 */
      --text:#1f2937;        /* slate-800 */
      --muted:#6b7280;       /* slate-500 */
      --accent:#f97316;      /* orange-500 */
      --accent-600:#ea580c;  /* orange-600 */
      --input-bg:#ffffff;
      --input-border:#e5e7eb;/* gray-200 */
      --img-bg:#fffaf0;      /* light warm */
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    a{color:var(--accent)}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .card{background:var(--panel);border:1px solid var(--panel-border);border-radius:12px;padding:16px;margin-bottom:16px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1 1 320px}
    input,select,button{border-radius:10px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--text);padding:10px 12px}
    input:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(249,115,22,0.15)}
    button{background:var(--accent);border-color:var(--accent-600);color:#fff;cursor:pointer}
    button:hover{background:var(--accent-600)}
    .muted{color:var(--muted)}
    .img-wrap{background:var(--img-bg);border:1px solid var(--panel-border);border-radius:10px;padding:8px;display:flex;justify-content:center;align-items:center;min-height:120px}
    img{max-width:100%;height:auto;border-radius:8px}
    ul{margin:8px 0 0 18px}
    .pill{display:inline-block;padding:2px 10px;border:1px solid var(--accent);background:rgba(249,115,22,0.08);border-radius:999px;margin:2px;font-size:12px;color:var(--accent-600)}
    .small{font-size:12px}
    .footer{margin-top:24px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Recipe Recommender</h1>
      <span class="muted small">Static web view (use with Live Server)</span>
    </header>

    <div class="card">
      <h3>Run pipeline first</h3>
      <p class="muted small">Generate plots by running: <code>py -m src.app --run-all</code>. Plots will be saved to <code>data/processed/</code>. Then refresh this page.</p>
    </div>

    <div class="row">
      <div class="col card">
        <h3>Graphs</h3>
        <div class="row">
          <div class="col">
            <div class="small muted">Category distribution (Pie)</div>
            <canvas id="chartPie"></canvas>
          </div>
          <div class="col">
            <div class="small muted">Top ingredients (Bar)</div>
            <canvas id="chartBar"></canvas>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <div class="small muted">Top ingredients (Line)</div>
            <canvas id="chartLine"></canvas>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <div class="col">
            <div class="small muted">Static: Category counts (generated by Python)</div>
            <div class="img-wrap"><img id="imgCat" alt="Category counts"></div>
          </div>
          <div class="col">
            <div class="small muted">Static: Top ingredients (generated by Python)</div>
            <div class="img-wrap"><img id="imgIng" alt="Top ingredients"></div>
          </div>
        </div>
        <div style="margin-top:8px" class="small muted">
          If these images are blank, run <code>py -m src.app --run-all</code> and click
          <button id="btnReload" style="margin-left:6px">Reload static images</button>
        </div>
      </div>

      <div class="col card">
        <h3>Try Recommendations (Client-side demo)</h3>
        <div class="small muted">Loads <code>data/raw/recipes.json</code> and computes a simple Jaccard similarity in your browser.</div>
        <div style="margin:12px 0; display:flex; gap:8px; align-items:center; flex-wrap:wrap">
          <input id="ing" type="text" placeholder="Ingredients (comma separated) e.g. chicken, tomato" style="flex:1 1 280px" />
          <select id="cat"></select>
          <button id="btn">Recommend</button>
        </div>
        <div id="results" class="small"></div>
      </div>
    </div>

    <div class="card">
      <h3>Tips</h3>
      <ul class="small">
        <li>Open this file with a local server (VS Code Live Server or <code>py -m http.server</code>).</li>
        <li>The graphs load directly from <code>data/raw/recipes.json</code>. Update that file and refresh to see changes.</li>
        <li>To show the static plot images above, run <code>py -m src.app --run-all</code> to generate <code>data/processed/category_counts.png</code> and <code>data/processed/top_ingredients.png</code>.</li>
      </ul>
    </div>

    <div class="footer muted small">© Demo project</div>
  </div>

  <script>
    // Compute proper paths relative to this file (web/index.html)
    const IMG_CAT = '../data/processed/category_counts.png';
    const IMG_ING = '../data/processed/top_ingredients.png';
    const DATA_JSON = '../data/raw/recipes.json';

    function setStaticImages() {
      const cat = document.getElementById('imgCat');
      const ing = document.getElementById('imgIng');
      if (cat) {
        let triedFallback = false;
        cat.onerror = () => {
          if (!triedFallback) {
            triedFallback = true;
            cat.src = '/data/processed/category_counts.png?t=' + Date.now();
          } else {
            cat.parentElement.innerHTML = 'Category plot not found. Run the pipeline first.';
          }
        };
        cat.src = IMG_CAT + '?t=' + Date.now();
      }
      if (ing) {
        let triedFallback2 = false;
        ing.onerror = () => {
          if (!triedFallback2) {
            triedFallback2 = true;
            ing.src = '/data/processed/top_ingredients.png?t=' + Date.now();
          } else {
            ing.parentElement.innerHTML = 'Ingredients plot not found. Run the pipeline first.';
          }
        };
        ing.src = IMG_ING + '?t=' + Date.now();
      }
    }

    function norm(s){ return (s||'').toString().trim().toLowerCase(); }
    function jaccard(a,b){
      const A = new Set(a), B = new Set(b);
      const inter = new Set([...A].filter(x => B.has(x))).size;
      const union = new Set([...A, ...B]).size;
      return union ? inter/union : 0;
    }

    async function loadData(){
      const res = await fetch(DATA_JSON);
      const j = await res.json();
      const foods = (j.foods||[]).map(f => ({
        id: f.id,
        title: f.title,
        category: f.category || '',
        ingredients: (f.ingredients||[]).map(x=>norm(x))
      }));
      const cats = (j.categories||[]).map(c => c.name).filter(Boolean);
      return {foods, cats};
    }

    function renderResults(items){
      const root = document.getElementById('results');
      if(!items.length){ root.innerHTML = '<span class="muted">No matches</span>'; return; }
      const html = items.map(it => `
        <div style="margin:8px 0;padding:8px;border:1px solid #1f2937;border-radius:8px">
          <div><strong>${it.title}</strong> <span class="pill">${it.category||'—'}</span></div>
          <div class="small muted">score: ${it.score.toFixed(3)}</div>
        </div>
      `).join('');
      root.innerHTML = html;
    }

    (async () => {
      try{
        const {foods, cats} = await loadData();
        const sel = document.getElementById('cat');
        sel.innerHTML = '<option value="">All Categories</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
        document.getElementById('btn').addEventListener('click', () => {
          const liked = document.getElementById('ing').value.split(',').map(x=>norm(x)).filter(Boolean);
          const cat = document.getElementById('cat').value;
          let df = foods.slice();
          if(cat) df = df.filter(r => norm(r.category) === norm(cat));
          const scored = df.map(r => ({...r, score: jaccard(r.ingredients, liked)}))
                           .sort((a,b) => b.score - a.score || a.ingredients.length - b.ingredients.length)
                           .slice(0,5);
          renderResults(scored);
        });

        // Build data for charts
        // Category counts
        const catCounts = foods.reduce((acc,r)=>{ const k = norm(r.category)||'unknown'; acc[k]=(acc[k]||0)+1; return acc; },{});
        const catLabels = Object.keys(catCounts);
        const catValues = catLabels.map(k=>catCounts[k]);

        // Ingredient frequencies
        const ingCounts = {};
        foods.forEach(r => (r.ingredients||[]).forEach(i => ingCounts[i] = (ingCounts[i]||0)+1));
        const ingSorted = Object.entries(ingCounts).sort((a,b)=>b[1]-a[1]).slice(0,15);
        const ingLabels = ingSorted.map(([k])=>k);
        const ingValues = ingSorted.map(([,v])=>v);

        // Render charts
        const palette = ['#f97316','#fdba74','#fb923c','#ea580c','#ffedd5','#fca5a5','#f59e0b','#fcd34d','#fda4af','#fb7185'];
        const ctxPie = document.getElementById('chartPie');
        const ctxBar = document.getElementById('chartBar');
        const ctxLine = document.getElementById('chartLine');

        // Pie: Categories
        new Chart(ctxPie, {
          type: 'pie',
          data: {
            labels: catLabels,
            datasets: [{ data: catValues, backgroundColor: catLabels.map((_,i)=> palette[i%palette.length]) }]
          },
          options: { plugins: { legend: { position: 'bottom' } } }
        });

        // Bar: Top ingredients
        new Chart(ctxBar, {
          type: 'bar',
          data: {
            labels: ingLabels,
            datasets: [{ label: 'Count', data: ingValues, backgroundColor: '#f97316' }]
          },
          options: {
            plugins: { legend: { display: false } },
            scales: { x: { ticks: { color: '#6b7280' } }, y: { beginAtZero: true } }
          }
        });

        // Line: Top ingredients (same data for a different perspective)
        new Chart(ctxLine, {
          type: 'line',
          data: {
            labels: ingLabels,
            datasets: [{ label: 'Count', data: ingValues, borderColor: '#ea580c', backgroundColor: 'rgba(234,88,12,0.15)', tension: 0.3, fill: true }]
          },
          options: { plugins: { legend: { position: 'bottom' } } }
        });
      } catch(e){
        document.getElementById('results').innerHTML = '<span class="muted">Failed to load data. Ensure the project is served over HTTP (not file://) and the JSON exists.</span>'
      }
    })();
  </script>
</body>
</html>
